<!DOCTYPE html>
<html>
<head>
  <title>Pos System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    html, body {
      height: 100% !important;
      width: 100% !important;
      margin: 0;
      overflow: hidden; /* ‚ùå ‡∏õ‡∏¥‡∏î scroll ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
    }
    body.swal2-shown {
      height: 100% !important;   /* ‚úÖ ‡∏Å‡∏±‡∏ô SweetAlert ‡∏ó‡∏≥ body ‡∏´‡∏î */
      overflow: hidden !important;
    }
    .swal2-container {
      overflow-y: hidden !important;  /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô scroll ‡∏Ç‡∏≠‡∏á SweetAlert */
    }
    body { background: #f0f6fb; font-family: Arial, sans-serif; }

    .pos-header { background: #1976d2; color: white; padding: 10px; height: 60px; }
    .pos-header h2 { margin: 0; font-size: 20px; }

    .pos-main { display: flex; height: calc(100% - 90px); } /* Header + Footer */
    .sidebar { background: #1565c0; color: white; padding: 15px; width: 220px; }
    .sidebar .btn { width: 100%; margin-bottom: 10px; }

    .content { flex: 1; padding: 15px; display: flex; flex-direction: column; }
    .cart-container { flex: 1; display: flex; flex-direction: column; }
    .cart-table { flex: 1; overflow-y: auto; } /* scroll ‡πÅ‡∏Ñ‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */

    .pos-status { background: #0d47a1; color: white; padding: 8px; font-size: 14px; height: 30px; }
    table th, table td { vertical-align: middle; }

    .big-text {
      font-size: 80px;
      font-weight: bold;
      text-align: right;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="pos-header d-flex justify-content-between align-items-center">
    <h2>KaiTodNongKing System</h2>
    <div>
      <strong>Time:</strong> {{ now }} |
      <strong>User:</strong> Admin |
      <strong>Total:</strong> {{total}}
    </div>
  </div>

  <!-- Main Layout -->
  <div class="pos-main">
    <!-- Sidebar -->
    <div class="sidebar">
      <a href="/" class="btn btn-light {% if mode=='uid' %}disabled{% endif %}">üõí Cart</a>

      <form method="POST" action="/mode/uid">
        <button type="submit" class="btn btn-warning" 
                {% if cart|length == 0 or mode=='uid' %}disabled{% endif %}>
          üí≥ Checkout
        </button>
      </form>

      <form method="POST" action="/mode/cancel">
        <button type="submit" class="btn btn-danger" {% if mode!="uid" %}disabled{% endif %}>
          ‚ùå Cancel Payment
        </button>
      </form>

      <a href="/add_product" class="btn btn-success {% if mode=='uid' %}disabled{% endif %}">‚ûï Add Product</a>
      <a href="/sales" class="btn btn-info {% if mode=='uid' %}disabled{% endif %}">üìë Sales History</a>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="cart-container">
        <h3>Cart</h3>

        <!-- üîπ ‡∏ä‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î -->
        <form method="POST" action="/scan" class="mb-3 d-flex">
          <input type="text" id="barcodeInput" name="barcode"
                placeholder="Scan barcode"
                class="form-control me-2"
                {% if mode == "uid" %}disabled{% endif %}
                required autofocus>
          <button type="submit" class="btn btn-primary"
                  {% if mode == "uid" %}disabled{% endif %}>
            Add
          </button>
        </form>

        <div class="cart-table">
          <table class="table table-bordered table-striped">
            <thead class="table-primary">
              <tr>
                <th>Barcode</th>
                <th>Description</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for item in cart %}
              <tr>
                <td>{{item.barcode}}</td>
                <td>{{item.name}}</td>
                <td>{{item.qty}}</td>
                <td>{{item.price}}</td>
                <td>{{item.price * item.qty}}</td>
                <td>
                  <form method="POST" action="/cart/update/{{item.barcode}}/add" style="display:inline">
                    <button type="submit" class="btn btn-sm btn-success"
                            {% if mode == "uid" %}disabled{% endif %}>+</button>
                  </form>
                  <form method="POST" action="/cart/update/{{item.barcode}}/remove" style="display:inline">
                    <button type="submit" class="btn btn-sm btn-danger"
                            {% if mode == "uid" %}disabled{% endif %}>‚àí</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="big-text">TOTAL: {{total}}</div>
        {% if mode == "uid" %}
        <div class="alert alert-info mt-3">‡∏£‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£...</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="pos-status d-flex justify-content-between align-items-center">
    <div>{{ now }}</div>
    <div>Item count: {{ cart|length }}</div>
  </div>

  <script>
    const socket = io();
    let currentUID = null;

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UID
    socket.on("uid_detected", data => {
      currentUID = data.uid;
      const statusEl = document.querySelector(".alert-info");
      if(statusEl){
        if(data.name){
          statusEl.innerText = "üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: " + data.name + " ‚Üí ‡∏£‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô...";
        } else {
          statusEl.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (UID: " + currentUID + ")";
        }
      }
    });

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Password
    socket.on("pwd_detected", data => {
      if(currentUID){
        socket.emit("auth_user", {uid: currentUID, password: data.password});
      }
    });

    // Auth Result
    socket.on("auth_result", data => {
      Swal.fire({
        icon: data.success ? "success" : "error",
        title: data.success ? "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß",
        html: `<h2 style="font-size:1.5rem">${data.msg}</h2>`,
        showConfirmButton: true,
        confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
        width: 500,
        padding: "2em",
        allowOutsideClick: false,
        allowEscapeKey: false,
        scrollbarPadding: false,
        heightAuto: false,   // ‚úÖ ‡∏Å‡∏±‡∏ô body ‡∏´‡∏î
        color: "#333",
        background: "#fff",
        backdrop: `
          rgba(0,0,123,0.4)
          url("https://sweetalert2.github.io/images/nyan-cat.gif")
          center top
          no-repeat
        `
      }).then(() => {
        if(data.success){
          window.location.href = "/";
        }
      });

      if(!data.success){
        const statusEl = document.querySelector(".alert-info");
        if(statusEl){
          statusEl.innerText = "‚ùå " + data.msg + " ‚Üí ‡∏£‡∏≠‡πÉ‡∏´‡∏°‡πà...";
        }
      }
    });

    // Autofocus + Clear ‡∏ä‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
    const barcodeInput = document.getElementById("barcodeInput");
    if(barcodeInput){
      barcodeInput.focus();
      document.querySelector("form[action='/scan']").addEventListener("submit", () => {
        setTimeout(() => { barcodeInput.value = ""; barcodeInput.focus(); }, 100);
      });
    }
  </script>
</body>
</html>
